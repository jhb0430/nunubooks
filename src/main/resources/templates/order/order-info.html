<!DOCTYPE html>
<html lang="ko" 
    xmlns:th="http://www.thymeleaf.org" 
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layout/default}">
     

		<section layout:fragment="contents">
		<div class="d-flex container">
			<nav class="nav flex-column category border-right mr-4">
			<div class="mt-4 mypage mr-1 border-bottom">
				<h4 class="font-weight-bold mt-3">마이 페이지</h4>
				<div class="mr-2 mt-2">
					<div  th:text="|${session.userName} 님 |">김뫄뫄님</div>
					<div class="small logo-color font-weight-bold" th:text="|(${#numbers.formatInteger(session.userPoint, 3, 'COMMA')} point)|">포인트</div>
				</div>
			</div>
				<div class="mr-1 text-center  mt-4">
					<h6 class="font-weight-bold mb-2">쇼핑 내역</h6>
					  <a class="nav-link text-dark" href="/nunubooks/order/orderHistory">주문 내역</a>
					<h6 class="font-weight-bold mb-2">회원정보</h6>
					  <a class="nav-link text-dark" href="/nunubooks/account/userInfo">회원정보 수정</a>
					  <!-- 
					  <a class="nav-link text-dark" href="/nunubooks/account/userInfo">회원정보 수정</a>
					  <a class="nav-link text-dark" href="#">카테고리3</a>
					  <a class="nav-link text-dark" href="#">카테고리4</a>
					   -->
				</div>
			</nav>
			<div class="contents">
			
					<div  class="order-header d-flex justify-content-between align-items-center border-bottom">
						<h3 class="font-weight-bold" >주문 / 배송 조회</h3>
						<!-- 
						<div class="d-flex">
							<button type="button" class="btn btn-outline-secondary">
								<i class="bi bi-calendar4"></i><span class="ml-1">상세 조회</span>
							</button>
						</div>
						 -->
					</div>
			
				<div class="border p-2 my-4 order-box">
					<table class="table text-center">
						<tr>
							<th>주문일자</th>
							<th>주문번호</th>
							<th>주문금액</th>
							<th>주문상태</th>
						</tr>
						<tr>
							<td th:text="${#temporals.format(orderUser.createdAt,'yyyy/MM/dd')}">2025/00/00</td>
							<td th:text="${merchantUid}">11111</td>
							<td>
							<div th:text="|${#numbers.formatInteger(orderUser.totalPrice, 3, 'COMMA')} 원|">12124원</div>
							<div th:text="|(${#numbers.formatInteger(orderUser.point, 3, 'COMMA')} point 적립)|">(000point 적립)</div>
							</td>
							<td>주문완료</td>
						</tr>
						
					</table>
				</div>
				
				<div class="border p-2 my-4 order-box">
				<h5 class="font-weight-bold">주문자 정보</h5>
					<table class="table">
					<tr>
						<th>배송지 정보</th>
						<td>
							<div>
							<span th:text="${orderUser.name}">이름</span>
							<span>/</span>
							<span th:text="${orderUser.phoneNumber}">전화번호</span>
							</div>
							<div>
							<span th:text="|[${orderUser.postcode}]|"></span>
							<span th:text="${orderUser.address}"></span>
							</div>
						</td>
					</tr>
					<tr>
						<th>배송 요청사항</th>
						<td>
							<div>
							어쩌구저쩌구 해주세요
							</div>
						</td>
					</tr>
					<tr>
						<th>결제수단</th>
						<td>
						<span th:text="${orderUser.payments}">신용카드</span>
						<span>어쩌구카드(*000)</span>
						</td>
					</tr>
					</table>
				</div>
				
				
				<div class="order-box"><!--주문내역확인 페이지 리스트-->
					<table class="table">
						<thead>
							<tr>
								<th  colspan="2">
								<span>주문 상품 정보</span>
								<span th:text="|(${orderInfo.item.size()})|">(9)</span>
								</th>
								<th class="text-success">
								<button type="button" class="btn btn-outline-secondary">
										<span>배송조회</span>
									</button>
								</th>
							</tr>
						</thead>
						<tbody th:each="orderInfo :${orderInfo}">
							<tr class="order-bookInfo" th:each="bookInfo : ${orderInfo.item}">
								<td  class="order-book-img">
									<img th:src="${bookInfo.cover}">
								</td>
								<td class="order-book-title align-middle">
									<div class="font-weight-bold" th:text="${bookInfo.title}">책 제목 어쩌구저쩌구저쩌구 </div>
									<div  th:text="|수량 : ${orderInfo.quantity} 개|">수량 :1개 </div>
								</td>
								<td class="order-book-amount align-middle text-center">
									<div class="font-weight-bold" th:text="|${#numbers.formatInteger(bookInfo.priceSales, 3, 'COMMA')} 원|">00000원</div>
								</td>
							</tr>
							
						</tbody>
							
					</table>
				
				</div>
						
			
			
			
			</div><!-- contents -->
		</div>
		</section>



	<script layout:fragment="script">
	
	//	https://portone.gitbook.io/docs/api/api-1/api
	//	결제 취소, 취소사유 ++ 
	//	POST https://api.iamport.kr/payments/cancel
	//	https://portone.gitbook.io/docs/auth/guide-2
	
	 function cancelPay() {
    jQuery.ajax({
      // 예: http://www.myservice.com/payments/cancel
      url: "https://api.iamport.kr/payments/cancel" 
      ,type: "POST"
      ,data: {
        "merchant_uid": "{결제건의 주문번호}" // 예: ORD20180131-0000011
        ,"cancel_request_amount": 2000 // 환불금액
        ,"reason": "테스트 결제 환불" // 환불사유
        // [가상계좌 환불시 필수입력] 환불 수령계좌 예금주
        ,"refund_holder": "홍길동" 
        // [가상계좌 환불시 필수입력] 환불 수령계좌 은행코드(예: KG이니시스의 경우 신한은행은 88번)
        ,"refund_bank": "88" 
        // [가상계좌 환불시 필수입력] 환불 수령계좌 번호
        ,"refund_account": "56211105948400" 
      }
    });
  }
	
	 STEP 02. 결제정보 조회하기
	 아래와 같이 결제정보를 저장하는 **Payments**라는 테이블을 생성했다고 가정합니다.

	 server-side
	 Copy
	 /* ... model/payments.js ... */
	   var mongoose = require('mongoose');
	   var Schema = mongoose.Schema;
	   ...
	   var PaymentsSchema = new Schema({
	     imp_uid: String, // 포트원 `unique key`(환불 요청시 `unique key`로 사용)
	     merchant_uid: String, // 주문번호(결제정보 조회시 사용)
	     amount: { type: Number, default: 0 }, // 결제 금액(환불 가능 금액 계산시 사용)
	     // 환불 된 총 금액(환불 가능 금액 계산시 사용)
	     cancel_amount: { type: Number, default: 0 }, 
	     ...
	   });
	   ...
	   module.exports = mongoose.model('Payments', PaymentsSchema);
	 클라이언트에서 받은 주문번호(merchant_uid)를 사용해서 해당 주문의 결제정보를 Payments 테이블에서 조회합니다.

	 server-side
	 Copy
	 /* ... 중략 ... */
	   var Payments = require('./models/payments');
	   app.post('/payments/cancel', async (req, res, next) => {
	     try {
	       /* 액세스 토큰(access token) 발급 */
	       /* ... 중략 ... */
	       /* 결제정보 조회 */
	       const { body } = req;
	       const { merchant_uid } = body; // 클라이언트로부터 전달받은 주문번호
	       Payments.find({ merchant_uid }, async function(err, payment) { 
	         if (err) {
	           return res.json(err);
	         }
	         const paymentData = payment[0]; // 조회된 결제정보
	         /* 포트원 REST API로 결제환불 요청 */
	         ...
	       });
	     } catch (error) {
	       res.status(400).send(error);
	     }
	   });
	 STEP 03. 아임포트 서버에 취소 요청하기
	 취소 요청을 하기 위해서 먼저 REST API access token 을 발급받습니다. 발급받은 액세스 토큰(access token)을 이용하여 아임포트 취소 API 를 호출하여 결제 취소를 요청합니다.

	 휴대폰 소액결제 환불 시 유의사항

	 결제가 이루어진 월과 환불을 요청하는 월이 다를 경우, 전액환불도 불가능합니다. 예를 들어, 1월 31일 결제건은 2월 1일에 환불할 수 없습니다.
	
	</script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
</html>